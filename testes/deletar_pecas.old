from selenium.common.exceptions import StaleElementReferenceException

def deletar_pecas(driver, os_gspn):
    """Deleta todas as pe√ßas cadastradas na OS do GSPN, incluindo cancelamento de G/I quando necess√°rio."""
    print(f"üîÑ Verificando pe√ßas inseridas na OS {os_gspn}...")
    original_window = driver.current_window_handle

    # 1Ô∏è‚É£ Aguardar a tabela de pe√ßas carregar
    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.ID, "partsTableBody"))
    )

    while True:
        try:
            # 2Ô∏è‚É£ Obter a lista de pe√ßas atualizada
            pecas = driver.find_elements(By.XPATH, "//tbody[@id='partsTableBody']/tr")
        except StaleElementReferenceException:
            # Caso o DOM tenha sido modificado, aguarda um instante e tenta novamente
            time.sleep(1)
            continue

        if not pecas:
            print("‚úÖ Nenhuma pe√ßa encontrada na OS.")
            return

        print(f"üîç {len(pecas)} pe√ßa(s) encontrada(s). Iniciando exclus√£o...")

        # 3Ô∏è‚É£ Processar cada pe√ßa (utiliza o tamanho original para evitar loops infinitos)
        for _ in range(len(pecas)):
            try:
                # Recoleta a lista para garantir que o elemento esteja atualizado
                pecas = driver.find_elements(By.XPATH, "//tbody[@id='partsTableBody']/tr")
                if not pecas:
                    print("‚úÖ Todas as pe√ßas foram removidas com sucesso.")
                    return
                peca = pecas[0]
            except StaleElementReferenceException:
                # Se a refer√™ncia estiver obsoleta, tenta novamente
                time.sleep(1)
                continue

            try:
                # Verificar se h√° bot√£o "Cancelar G/I"
                botao_cancelar_gi = peca.find_elements(By.XPATH, ".//input[@value='Cancelar G/I']")
                if botao_cancelar_gi:
                    print("‚ö†Ô∏è Pe√ßa requer cancelamento de G/I antes da exclus√£o. Processando...")
                    botao_cancelar_gi[0].click()

                    # Aguardar at√© que uma nova janela seja aberta
                    WebDriverWait(driver, 10).until(lambda d: len(d.window_handles) > 1)

                    # Alternar para a nova janela
                    driver.switch_to.window(driver.window_handles[-1])
                    new_window = driver.current_window_handle

                    # Aguardar e clicar no bot√£o "Cancelar G/I" na nova janela
                    botao_confirmar_cancelamento = WebDriverWait(driver, 10).until(
                        EC.element_to_be_clickable((By.XPATH, "//span[@id='buttonName']/a[contains(text(), 'Cancelar G/I')]"))
                    )
                    botao_confirmar_cancelamento.click()
                    print("‚úÖ Cancelamento de G/I solicitado.")

                    # Tentar aceitar o alerta, mas sem esperar indefinidamente (a janela pode fechar instantaneamente)
                    try:
                        WebDriverWait(driver, 3).until(EC.alert_is_present())
                        alert = driver.switch_to.alert
                        alert.accept()
                        print("‚úÖ Alerta de confirma√ß√£o aceito.")
                    except Exception:
                        print("Nenhum alerta foi exibido ou j√° foi tratado.")

                    # Esperar que a nova janela seja fechada
                    WebDriverWait(driver, 10).until(lambda d: new_window not in d.window_handles)

                    # Retornar diretamente para a janela original
                    driver.switch_to.window(original_window)
                    print("‚úÖ Retornou para a aba original.")

                # Localizar e clicar no bot√£o de deletar a pe√ßa
                botao_deletar = peca.find_elements(By.XPATH, ".//a[@name='partsDeleteBtn']")
                if botao_deletar:
                    pecas_antes = len(driver.find_elements(By.XPATH, "//tbody[@id='partsTableBody']/tr"))
                    botao_deletar[0].click()
                    print("üóëÔ∏è Pe√ßa exclu√≠da.")

                    # Aguardar e aceitar o alerta de confirma√ß√£o de exclus√£o
                    try:
                        WebDriverWait(driver, 5).until(EC.alert_is_present())
                        alert = driver.switch_to.alert
                        alert.accept()
                        print("‚úÖ Confirma√ß√£o de exclus√£o aceita.")
                    except Exception:
                        print("Alerta de confirma√ß√£o n√£o apareceu ou j√° foi tratado.")

                    # Aguardar que a quantidade de pe√ßas diminua
                    WebDriverWait(driver, 15).until(
                        lambda d: len(d.find_elements(By.XPATH, "//tbody[@id='partsTableBody']/tr")) < pecas_antes
                    )
                    print("üîÑ P√°gina recarregada ap√≥s exclus√£o da pe√ßa.")

                    # Sair do loop para reavaliar a lista de pe√ßas
                    break

            except StaleElementReferenceException:
                print("‚ö†Ô∏è Elemento obsoleto, tentando novamente...")
                continue
            except Exception as e:
                print(f"‚ö†Ô∏è Erro ao processar pe√ßa: {e}")
                continue
